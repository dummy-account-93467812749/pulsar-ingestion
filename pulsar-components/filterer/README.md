# Event Type Splitter Function

## Overview

The Event Type Splitter, located in the `filterer` directory, is a Pulsar Function designed to route `CommonEvent` messages to different Pulsar topics. Its main class is `com.example.pulsar.functions.routing.EventTypeSplitter`. It receives messages as JSON strings, deserializes them into a `com.example.pulsar.common.CommonEvent` object, and then uses the `eventType` field within this object to determine the appropriate target topic for republishing the original message.

-   **Purpose:** Dynamically routes messages based on their content.
-   **Mechanism:** Inspects the `eventType` field of incoming `CommonEvent` objects.
-   **Input:** Expects a JSON string that can be deserialized into a `com.example.pulsar.common.CommonEvent`.

## `EventTypeSplitter` Function Details

-   **Class Name:** `com.example.pulsar.functions.routing.EventTypeSplitter`
-   **Input Schema:** The function expects a JSON string payload that represents a `CommonEvent`.
    ```json
    // Example CommonEvent structure (from common module)
    {
      "eventId": "string",
      "source":  "string",
      "eventType": "string", // This field drives the routing
      "timestamp": "ISO8601", // e.g., "2023-01-01T00:00:00Z"
      "data": { /* any valid JSON object */ }
    }
    ```
-   **Output:** The function has a `Void` return type. It does not return a value directly from the `process` method but instead publishes the original input message to dynamically determined Pulsar topics.
-   **Routing Logic:**
    -   The target topic is constructed using the pattern: `persistent://<tenant>/<namespace>/fn-split-<sanitized_event_type>`.
    -   Currently, the `tenant` and `namespace` for these output topics are hardcoded within the function to `public` and `default`, respectively. (This could be enhanced in the future to be configurable).
    -   The `sanitized_event_type` is generated by:
        1.  Taking the `eventType` string from the `CommonEvent`.
        2.  Converting it to lowercase.
        3.  Replacing any sequence of one or more non-alphanumeric characters (excluding hyphens, as per current implementation `[^a-z0-9-]`) with a single hyphen (`-`). For example, `Order Placed! V2` would become `order-placed--v2`.
-   **Dependencies:** This function relies on the `common` module of this project for the `com.example.pulsar.common.CommonEvent` data class definition.

## Building the Function

To build the function and produce the necessary JAR file, run the following Gradle command from the root of the project:

```bash
./gradlew :pulsar-components:filterer:clean :pulsar-components:filterer:build
```

This command will compile the function, run its tests, and package it into a fat JAR.
The output JAR will be located at `pulsar-components/filterer/build/libs/filterer.jar`. The `shadowJar` configuration typically results in `filterer.jar` (matching the project name) when `archiveClassifier` is empty.

## Testing the Function

The function module includes both unit and integration tests.

-   **Unit Tests:** Execute the unit tests using:
    ```bash
    ./gradlew :pulsar-components:filterer:test
    ```
-   **Integration Tests:** Execute the integration tests, which use Testcontainers to spin up a Pulsar instance, using:
    ```bash
    ./gradlew :pulsar-components:filterer:integrationTest
    ```

## Deployment Example

Below is an example command for deploying the `EventTypeSplitter` function using `pulsar-admin`.

```bash
pulsar-admin functions create \
  --jar path/to/your/pulsar-components/filterer/build/libs/filterer.jar \
  --classname com.example.pulsar.functions.routing.EventTypeSplitter \
  --inputs persistent://public/default/common-events-topic \
  --name EventTypeSplitterFunction \
  --tenant public \
  --namespace default
  # --parallelism 1 # Optional: and other standard function configurations
```

**Important Notes:**
-   Replace `path/to/your/` with the actual path to the JAR file on your system or in your deployment package.
-   The `--inputs` topic (`persistent://public/default/common-events-topic` in the example) should be the topic where your raw JSON `CommonEvent` messages are being produced.
-   The `--output` parameter is **not** specified because this function routes messages to multiple topics dynamically based on the event type.

## Configuration

-   **Input Topic:** The function consumes messages from the topic specified in the `--inputs` parameter during deployment.
-   **Output Topics:** Output topics are generated dynamically based on the pattern `persistent://public/default/fn-split-<sanitized_event_type>`.
    -   As mentioned, the tenant (`public`) and namespace (`default`) for output topics are currently hardcoded.
-   **Future Enhancements:** For more flexibility, future versions could allow configuration of the output topic pattern (e.g., tenant, namespace, prefix) via the function's User Config (`--user-config` option during deployment).
