# Project Deployment Artifacts

## 1. Overview

This directory contains all necessary artifacts and configurations for deploying the project's Pulsar functions and connectors across different environments, including local development (Docker Compose) and Kubernetes (via Helm).

The deployment process is primarily driven by the `generateManifests` Gradle task, which processes definitions from `pipeline.yaml` and connector configurations to produce deployment-ready files.

## 2. Sources of Truth

The deployment configurations are primarily defined in the following locations:

*   **`deployment/pipeline.yaml`**: This file is the central configuration for defining the Pulsar pipeline. It includes:
    *   Target Pulsar tenant and namespace.
    *   Definitions for all Pulsar Functions, including their inputs, outputs, class names, and any specific configurations.
*   **`connectors/**/connector.yaml`**: Each subdirectory within the `/connectors` directory (e.g., `/connectors/s3-sink/`) should contain a `connector.yaml` file. This file defines:
    *   The connector's name, type (source or sink), image/archive, and target topic.
    *   A reference to a specific configuration file (e.g., `config.dev.yaml`) containing the detailed settings for that connector.

These files serve as the input for the `generateManifests` Gradle task.

## 3. Directory Structure (`/deployment`)

The `/deployment` directory is organized as follows:

*   **`pipeline.yaml`**:
    *   The central pipeline configuration file described above.

*   **`/deployment/worker/`**:
    *   Contains a standalone Helm chart for deploying functions and connectors to Kubernetes. This deployment method operates *without* relying on Pulsar Function Mesh.
    *   **`Chart.yaml`**: Helm chart definition.
    *   **`values.yaml`**: Helm values file. **This file is populated by the `generateManifests` task with data from `pipeline.yaml` and connector configurations.** It is not meant to be manually edited for defining the pipeline instances.
    *   **`templates/`**: Contains Helm templates (e.g., `registration-job.yaml`) that define how functions and connectors are registered with Pulsar as part of a Kubernetes Job.
    *   **Purpose**: Suitable for Kubernetes environments where Function Mesh is not available or desired. Resources are typically registered via a batch job.

*   **`/deployment/mesh/`**:
    *   Contains a standalone Helm chart for deploying functions and connectors to Kubernetes *with* Pulsar Function Mesh.
    *   **`Chart.yaml`**: Helm chart definition.
    *   **`values.yaml`**: Helm values file. **This file is populated by the `generateManifests` task with data from `pipeline.yaml` and connector configurations.**
    *   **`templates/`**: Contains Helm templates (e.g., `function-mesh.yaml`) that generate FunctionMesh custom resources.
    *   **Purpose**: Ideal for Kubernetes environments where Function Mesh is installed, allowing for a more declarative and Kubernetes-native way of managing Pulsar functions and connectors.

*   **`/deployment/compose/`**:
    *   Contains configurations for the Docker Compose-based local development setup.
    *   **`docker-compose.yml`**: Defines the local services (Pulsar, etc.) and volume mounts for function JARs and connector NARs/JARs. This file is located in `/deployment/compose/`.
    *   **`bootstrap.sh`**: **This script is auto-generated by the `generateManifests` task and placed in `/deployment/compose/bootstrap.sh`.** It contains `pulsar-admin` commands to provision all defined functions and connectors in the local Pulsar instance started by `docker-compose up`.
    *   **`bootstrap.sh.tpl`**: A template file located in `/deployment/compose/bootstrap.sh.tpl`. It served as an initial structural reference for the auto-generated `bootstrap.sh` and is not directly used by the `generateManifests` task at runtime.
    *   **`scripts/`**: Contains supporting scripts for the local Docker Compose environment, such as `load-test.sh` and `docker-pulsar-entrypoint.sh`.

## 4. `generateManifests` Gradle Task

The `./gradlew generateManifests` task is the central command for preparing deployment artifacts. It reads the pipeline and connector definitions and generates the necessary files for each deployment target.

*   **Inputs:**
    *   `deployment/pipeline.yaml`
    *   `connectors/**/connector.yaml` (and their referenced configuration files)

*   **Outputs:**

    *   **Worker (Kubernetes - No Mesh):**
        *   Populates a temporary Helm values file (e.g., `build/tmp/worker_values.yaml`) based on the inputs.
        *   Generates Kubernetes manifests to `build/deploy/worker/generated-manifests.yaml` by running `helm template` with the `/deployment/worker/` chart and the generated values.

    *   **Mesh (Kubernetes - With Function Mesh):**
        *   Populates a temporary Helm values file (e.g., `build/tmp/mesh_values.yaml`) based on the inputs.
        *   Generates Kubernetes manifests to `build/deploy/mesh/generated-manifests.yaml` by running `helm template` with the `/deployment/mesh/` chart and the generated values.

    *   **Compose (Local Docker Compose):**
        *   Directly generates the `deployment/compose/bootstrap.sh` script. This script contains `pulsar-admin` commands to set up the functions and connectors using the Pulsar instance defined in `deployment/compose/docker-compose.yml`.

## 5. Deployment Methods

### 5.1. Worker (Kubernetes - No Mesh)

1.  **Generate Manifests:**
    ```bash
    ./gradlew generateManifests
    ```
2.  **Apply to Kubernetes:**
    Ensure your `kubectl` context is configured for the target Kubernetes cluster where Pulsar is running.
    ```bash
    kubectl apply -f build/deploy/worker/generated-manifests.yaml
    ```
    This will typically create a Kubernetes Job that registers the functions and connectors with the Pulsar cluster.
3.  **Prerequisites:**
    *   A running Pulsar cluster accessible from your Kubernetes cluster.
    *   `kubectl` configured to communicate with your Kubernetes cluster.

### 5.2. Mesh (Kubernetes - With Function Mesh)

1.  **Generate Manifests:**
    ```bash
    ./gradlew generateManifests
    ```
2.  **Apply to Kubernetes:**
    Ensure your `kubectl` context is configured for the target Kubernetes cluster.
    ```bash
    kubectl apply -f build/deploy/mesh/generated-manifests.yaml
    ```
    This will create FunctionMesh custom resources (e.g., `Function`, `Source`, `Sink`).
3.  **Prerequisites:**
    *   A running Pulsar cluster.
    *   Pulsar Function Mesh installed and configured on your Kubernetes cluster.
    *   `kubectl` configured.

### 5.3. Compose (Local Docker Compose)

1.  **Generate Bootstrap Script (if not running `composeUp`):**
    The `generateManifests` task (which is a dependency of `composeUp`) will generate `deployment/compose/bootstrap.sh`.
    ```bash
    ./gradlew generateManifests
    ```
2.  **Start Services & Provision:**
    The `composeUp` Gradle task handles running Docker Compose from the correct directory (`deployment/compose/`).
    ```bash
    # From the project root
    ./gradlew composeUp 
    ```
    This command will:
    1.  Ensure `generateManifests` is run, which creates/updates `deployment/compose/bootstrap.sh`.
    2.  Start the services defined in `deployment/compose/docker-compose.yml` in detached mode.
    The `bootstrap.sh` script is typically executed by an entrypoint defined in the `docker-compose.yml` for the Pulsar service, provisioning the functions and connectors.
3.  **Volume Mounts:**
    The `deployment/compose/docker-compose.yml` file is configured to mount necessary directories:
    *   Custom connector NAR/JAR files (e.g., from `/connectors/.../build/libs/`) are mounted into `/pulsar/connectors/` inside the Pulsar container.
    *   Function JAR files (e.g., from `/functions/.../build/libs/`) are mounted into `/pulsar/functions/` inside the Pulsar container.
    The auto-generated `deployment/compose/bootstrap.sh` script assumes these JARs/NARs are available at these conventional paths.

## 6. Local Development Setup (`/deployment/compose/`)

The `/deployment/compose/` directory is the definitive location for all Docker Compose-based local development configurations. The previously used `/deployment/local-dev/` directory has been removed and its relevant configurations and scripts consolidated into `/deployment/compose/`.

Key files for local development:
*   **`deployment/compose/docker-compose.yml`**: The Docker Compose file.
*   **`deployment/compose/bootstrap.sh`**: The auto-generated provisioning script.
*   **`deployment/compose/scripts/`**: Contains helper scripts for the local environment.

Refer to the instructions in section "5.3. Compose (Local Docker Compose)" for running the local setup.

## 7. Outdated Sections (Previously `/deployment/helm`)

All prior documentation referring to a monolithic `/deployment/helm` umbrella chart and its specific templates (`function-mesh.yaml.tpl`, `registration-job.yaml.tpl`, etc.) is now outdated due to the refactoring into separate, standalone Helm charts in `/deployment/worker/` and `/deployment/mesh/`, and the direct script generation for `/deployment/compose/`.
